<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Watch & Earn | Nexa</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f8ff;
      color: #333;
    }

    header {
      background-color: #6c4ad0;
      color: #fff;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.5px;
    }

    header button {
      background: #fff;
      color: #6c4ad0;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
    }

    header button:hover {
      background: #e9e4ff;
    }

    .content {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .video-card {
      background: #fff;
      border: 1px solid #e4e4e4;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(108, 74, 208, 0.08);
      transition: transform 0.2s ease;
    }

    .video-card:hover {
      transform: translateY(-3px);
    }

    .video-card h3 {
      margin-bottom: 12px;
      font-size: 18px;
      color: #4b2ab8;
    }

    video {
      width: 100%;
      border-radius: 8px;
      background: #000;
      display: block;
    }

    .video-actions {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button[data-action="claim"] {
      background: #6c4ad0;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    button[data-action="claim"]:hover:not(:disabled) {
      background: #583ac2;
    }

    button[disabled] {
      background: #ccc;
      cursor: not-allowed;
    }

    .status {
      font-size: 14px;
      color: #555;
    }

#videos {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

    @media (max-width: 600px) {
      .content {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>üé• Watch & Earn</h1>
    <button onclick="window.location.href='dashboard.html'">‚¨Ö Back to Dashboard</button>
  </header>

  <div class="content">
    <div id="videos"></div>
  </div>

<script>
  const user = JSON.parse(sessionStorage.getItem('user') || '{}');
  const username = user.username;

  if (!username) {
    document.body.innerHTML = '<p style="color:red;text-align:center;">Please log in to view videos.</p>';
    throw new Error("User not logged in");
  }

  async function loadVideos() {
    const container = document.getElementById('videos');

    try {
      const res = await fetch('https://nexa-project-l5pg.onrender.com/api/videos');
      const data = await res.json();
      container.innerHTML = '';

      if (!data.videos || data.videos.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#777;">No videos available yet.</p>';
        return;
      }

      data.videos.forEach(v => {
        console.log("Video:", v);

        const card = document.createElement('div');
        card.className = 'video-card';
card.innerHTML = `
  <h3>${v.title || 'Watch'} ‚Äî ‚Ç¶${Number(v.reward).toFixed(2)}</h3>
  <video id="video-${v.id}" playsinline preload="metadata" controls></video>
  <div class="video-actions">
    <button data-action="play" data-id="${v.id}">‚ñ∂Ô∏è Watch</button>
    <button data-action="claim" data-id="${v.id}" disabled>Claim Reward</button>
    <span class="status" id="status-${v.id}"></span>
  </div>
`;

        container.appendChild(card);

        const videoEl = card.querySelector('video');
       const playBtn = card.querySelector('button[data-action=play]');
playBtn.addEventListener('click', () => {
  videoEl.src = v.url;
  videoEl.play();
  playBtn.disabled = true;
});

        const btn = card.querySelector('button[data-action=claim]');
        const status = card.querySelector('.status');

        // Disable right-click
        videoEl.addEventListener('contextmenu', e => e.preventDefault());

        // Prevent skipping
        let lastTime = 0;
        videoEl.addEventListener('timeupdate', () => {
          if (videoEl.currentTime - lastTime > 1) {
            videoEl.currentTime = lastTime;
          } else {
            lastTime = videoEl.currentTime;
          }
        });

        // Pause when user switches tab
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) videoEl.pause();
          else videoEl.play();
        });

        // When video ends -> enable claim
        videoEl.addEventListener('ended', () => {
          btn.disabled = false;
          status.innerText = 'You can now claim your reward!';
        });

        // üéØ Claim reward + handle redirect
        btn.addEventListener('click', async () => {
          btn.disabled = true;
          status.innerText = 'üîó Opening link...';

          try {
            let delay = 0;

            if (v.redirect && v.redirect.trim() !== '') {
              const newTab = window.open(v.redirect, '_blank');
              if (!newTab) {
                alert("Please allow popups or click again to open the link.");
                btn.disabled = false;
                status.innerText = 'Popup blocked.';
                return;
              }
              delay = 4000; // wait 4 seconds if redirect link exists
            }

            setTimeout(async () => {
              status.innerText = '‚è≥ Crediting reward...';
              const r = await fetch('https://nexa-project-l5pg.onrender.com/api/videos/claim', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, video_id: v.id })
              });
              const j = await r.json();

              if (j.success) {
                status.innerText = `Reward Credited: ‚Ç¶${j.reward}`;
                btn.disabled = true;
              } else {
                status.innerText = j.message || 'Error claiming reward.';
                btn.disabled = false;
              }
            }, delay);

          } catch (err) {
            console.error(err);
            status.innerText = 'Error processing reward.';
            btn.disabled = false;
          }
        });
      });
    } catch (err) {
      console.error('Failed to load videos', err);
      container.innerHTML =
        '<p style="text-align:center;color:red;">Error loading videos.</p>';
    }
  }

  loadVideos();
</script>

</body>
</html>
